Include /opt/ericsson/sso/web_agents/apache22_agent/Agent_001/config/dsame.conf

LoadModule ssl_module modules/mod_ssl.so

Listen 192.168.124.9:443
#Listen 192.168.124.9:80

SSLPassPhraseDialog  builtin

SSLSessionCache         shmcb:/var/cache/mod_ssl/scache(512000)
SSLSessionCacheTimeout  300

SSLMutex default

SSLRandomSeed startup file:/dev/urandom  256
SSLRandomSeed connect builtin

SSLCryptoDevice builtin


<VirtualHost httpd-micro-deployment-7c8d5f96fd-542vn:443 cmserv.app.enmaas.io:443>

	ServerName app.enmaas.io

	SSLEngine on
	SSLProtocol all -SSLv2 -SSLv3
	SSLCipherSuite HIGH:MEDIUM:MD5:!NULL:!aNULL:!eNULL:!LOW:@STRENGTH

	SSLCertificateFile /etc/pki/tls/certs/ApacheCert.crt
	SSLCertificateKeyFile /etc/pki/tls/private/ApacheCert.key
	SSLProxyEngine on
	
	Options -Indexes

	<Location />
		Order allow,deny
		Allow from all
	</Location>

	RewriteEngine On

	<Proxy balancer://oldagentclusterlogin>
    		BalancerMember https://sso.app.enmaas.io:8443/heimdallr/UI/Login
    		BalancerMember https://sso.app.enmaas.io:8443/heimdallr/UI/Login status=+H
    </Proxy>

	<Proxy balancer://agentclusterlogin>
		BalancerMember https://sso.app.enmaas.io:8443/singlesignon/2.0/login
		BalancerMember https://sso.app.enmaas.io:8443/singlesignon/2.0/login status=+H
	</Proxy>

	<Proxy balancer://agentclusterlogout>
		BalancerMember https://sso.app.enmaas.io:8443/heimdallr/UI/Logout
		BalancerMember https://sso.app.enmaas.io:8443/heimdallr/UI/Logout status=+H
	</Proxy>

	# Disable HTTP TRACE and TRACK methods
	RewriteCond %{REQUEST_METHOD} ^(TRACE|TRACK)
	RewriteRule .* - [F]
	
	#TORF-286140 and TORF-286656
	RewriteCond %{REQUEST_URI} ^\/err401\/login.html$
    RewriteRule .* - [R=401,L]
	
	# Fix for ?goto being something else than servername in case of HTTPS
	RewriteCond %{REQUEST_URI} ^\/login\/(index.html)?$
	RewriteCond %{HTTPS} on
	RewriteCond %{SERVER_NAME},%{QUERY_STRING} !^(.+),(.+)?goto=https(:\/\/|%3A%2F%2F)\1 [NC]
	RewriteRule .* /login/?goto=https://%{SERVER_NAME} [L,R]


	# Fix for ?goto being something else than servername in case of HTTP
	RewriteCond %{REQUEST_URI} ^\/login\/(index.html)?$
	RewriteCond %{HTTPS} !on
	RewriteCond %{SERVER_NAME},%{QUERY_STRING} !^(.+),(.+)?goto=http(:\/\/|%3A%2F%2F)\1 [NC]
	RewriteRule .* /login/?goto=http://%{SERVER_NAME} [L,R]

	# Fix for ?goto being something else than servername in case of HTTPS
    RewriteCond %{REQUEST_URI} ^\/logout?$
    RewriteCond %{HTTPS} on
    RewriteCond %{SERVER_NAME},%{QUERY_STRING} !^(.+),(.+)?goto=https(:\/\/|%3A%2F%2F)\1 [NC]
    RewriteRule .* /logout?goto=https://%{SERVER_NAME} [L,PT]

    # Fix for ?goto being something else than servername in case of HTTP
    RewriteCond %{REQUEST_URI} ^\/logout?$
    RewriteCond %{HTTPS} !on
    RewriteCond %{SERVER_NAME},%{QUERY_STRING} !^(.+),(.+)?goto=http(:\/\/|%3A%2F%2F)\1 [NC]
    RewriteRule .* /logout?goto=http://%{SERVER_NAME} [L,PT]


	<Location /index.html>
		Header set Cache-Control "no-store, no-cache, must-revalidate, post-check=0, pre-check=0"
		Header set Pragma "no-cache"
		Header set Expires "Thu, 19 Nov 1981 08:52:00 GMT"
	</Location>

	# Login gets POST request on /login that we proxy to new openAM endpoint
    RewriteCond %{REQUEST_METHOD}   ^POST
    RewriteCond /opt/ericsson/sso/.login_check -f
    RewriteRule ^/login$ https://sso.app.enmaas.io:8443/singlesignon/2.0/login [QSA,L,P]
    ProxyPassReverse /login balancer://agentclusterlogin

    # Login gets POST request on /login that we proxy to old openAM endpoint
    RewriteCond %{REQUEST_METHOD}   ^POST
    RewriteCond /opt/ericsson/sso/.login_check !-f
    RewriteRule ^/login$ https://sso.app.enmaas.io:8443/heimdallr/UI/Login [QSA,L,P]
    ProxyPassReverse /login balancer://oldagentclusterlogin


	# Logout gets GET request on /logout that we proxy to openAM
	RewriteCond %{REQUEST_METHOD}   ^GET$
	RewriteRule ^/logout$ https://sso.app.enmaas.io:8443/heimdallr/UI/Logout [QSA,L,P]
	# ProxyPassReverse /logout https://sso.app.enmaas.io:8443/heimdallr/UI/Logout
	ProxyPassReverse /logout balancer://agentclusterlogout

	ProxyPass /heimdallr/isAlive.jsp http://sso.app.enmaas.io:8080/heimdallr/isAlive.jsp
	ProxyPassReverse /heimdallr/isAlive.jsp http://sso.app.enmaas.io:8080/heimdallr/isAlive.jsp
	ProxyPass /heimdallr/identity/authenticate http://sso.app.enmaas.io:8080/heimdallr/identity/authenticate
	ProxyPassReverse /heimdallr/identity/authenticate http://sso.app.enmaas.io:8080/heimdallr/identity/authenticate

    # Redirect the SSO default landing page
    	RewriteCond %{REQUEST_METHOD}   ^GET
    	ProxyPassReverse /login/success http://sso.app.enmaas.io:8080/heimdallr/console
    	RewriteCond %{REQUEST_METHOD}   ^GET
    	ProxyPassReverse /login/success https://sso.app.enmaas.io:8443/heimdallr/console

	Include conf.d/virtualhost_includes/*.conf

</VirtualHost>
